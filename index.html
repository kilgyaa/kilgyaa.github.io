<!DOCTYPE html>
<html data-color-theme="auto">

<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="apple-mobile-web-app-title" content="Kílgyaa">
    <meta name="theme-color" content="#b71c1c">

    <link rel="stylesheet" media="screen" href="style.css" />

    <link rel="icon" type="image/png" href="assets/favicon.png" />

    <title>Kílgyaa: an interactive dictionary of X̱aad Kíl (the Haida language)</title>
    <meta name="Description" content="Kílgyaa: an interactive dictionary of X̱aad Kíl (the Haida language)">
</head>

<body>

    <header class="row collapse">
        <div class="small-4 columns">
            <h1 class="logo">
                <img src="assets/logo.png"></img>
            </h1>
        </div>
        <div class="small-8 columns">
            <nav class="main-nav">
                <ul class="nav-menu">
                    <li><a href="#" class="nav-link active" data-page="dictionary">Dictionary</a></li>
                    <li><a href="#" class="nav-link" data-page="corpus">Corpus</a></li>
                    <li><a href="#" class="nav-link" data-page="conjugator">Conjugator</a></li>
                    <li><a href="#" class="nav-link" data-page="lessons">Lessons</a></li>
                    <li><a href="#" class="nav-link" data-page="resources">Resources</a></li>
                    <li><a href="#" class="nav-link" data-page="acknowledgements">Acknowledgements</a></li>
                </ul>
                <div class="ortho-controls" style="margin-top: 10px;">
                    <label for="orthography-select">Orthography:</label>
                    <select id="orthography-select">
                        <option value="lachler" selected>Lachler</option>
                        <option value="classic">Classic</option>
                    </select>
                </div>
            </nav>
        </div>
    </header>


    <div class="row collapse">
        <div class="large-12 columns">
            <form class="search" data-live="false" id="search" action="/search" accept-charset="UTF-8" method="get">
                <input name="utf8" type="hidden" value="&#x2713;" />
                <div class="overlay">
                    <div id="search_main" class="main">
                        <div class="inner">
                            <!-- <div id="advanced_button" class="search_type">
                                <span class="text" id="search_dropdown_text">All</span>
                                <span class="carat">▾</span> -->
                            <!-- </div> -->
                            <button type="submit" class="submit icon" tabindex="2">
                                <svg width="20px" height="20px" viewBox="0 0 30 30" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M15.7955 15.8111L21 21M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z"
                                        stroke="#000000" stroke-width="3" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>

                            </button>
                            <a class="search-form_clear-button_js search-form_clear-button icon" accesskey="1"
                                tabindex="3">
                                <svg width="20px" height="20px" viewBox="0 0 30 30" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                    <g id="icons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                        <g id="ui" transform="translate(-869.000000, -159.000000)" fill="#252528"
                                            fill-rule="nonzero">
                                            <g id="square-filled" transform="translate(50.000000, 120.000000)">
                                                <path
                                                    d="M820.716328,39.2890737 L830,48.573 L839.283672,39.2890737 C839.644156,38.9285898 840.211387,38.9008602 840.603678,39.2058851 L840.710926,39.3021143 C841.101451,39.6926386 841.101451,40.3258036 840.710926,40.7163279 L831.427,50 L840.710926,59.2836721 C841.07141,59.6441561 841.09914,60.2113872 840.794115,60.6036784 L840.697886,60.7109263 C840.307361,61.1014506 839.674196,61.1014506 839.283672,60.7109263 L830,51.427 L820.716328,60.7109263 C820.355844,61.0714102 819.788613,61.0991398 819.396322,60.7941149 L819.289074,60.6978857 C818.898549,60.3073614 818.898549,59.6741964 819.289074,59.2836721 L828.573,50 L819.289074,40.7163279 C818.92859,40.3558439 818.90086,39.7886128 819.205885,39.3963216 L819.302114,39.2890737 C819.692639,38.8985494 820.325804,38.8985494 820.716328,39.2890737 Z M819.996181,40.0092211 L829.987233,50 L819.996181,59.9907789 L820.009221,60.0038195 L830,50.0127671 L839.990779,60.0038195 L840.003819,59.9907789 L830.012767,50 L840.003819,40.0092211 L839.990779,39.9961805 L830,49.9872329 L820.009221,39.9961805 L819.996181,40.0092211 Z"
                                                    id="cancel">

                                                </path>
                                            </g>
                                        </g>
                                    </g>
                                </svg>

                            </a>

                            <a class="keyboard-button_js keyboard-button icon" tabindex="4">
                                <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 7C3 5.89543 3.89543 5 5 5H19C20.1046 5 21 5.89543 21 7V17C21 18.1046 20.1046 19 19 19H5C3.89543 19 3 18.1046 3 17V7Z" stroke="#252528" stroke-width="2"/>
                                    <path d="M7 9H7.01M10 9H10.01M13 9H13.01M16 9H16.01M8.5 12H8.51M11.5 12H11.51M14.5 12H14.51M7 15H17" stroke="#252528" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </a>

                            <div class="text_input">
                                <div class="hidden range"></div>
                                <input type="text" class="keyword" name="keyword" id="keyword" value="" tabindex="1"
                                    lang="ja" autocapitalize="off" autocomplete="off" autocorrect="off"
                                    spellcheck="false" placeholder="Word in X̱aad Kíl (e.g. íijang)"
                                    data-autoload="false" data-effective-keyword="" />
                            </div>
                        </div>
                    </div>
                </div>

            </form>
            
            <!-- Special Character Input Panel -->
            <div id="character-panel" class="character-panel" style="display: none;">
                <div class="character-panel-content">
                    <div class="character-panel-header">
                        <h4>Special Characters</h4>
                        <button class="character-panel-close">&times;</button>
                    </div>
                    <div class="character-groups">
                        <div class="character-group">
                            <h5>Vowels with acute accent</h5>
                            <div class="character-buttons">
                                <button class="char-btn" data-char="á">á</button>
                                <button class="char-btn" data-char="é">é</button>
                                <button class="char-btn" data-char="í">í</button>
                                <button class="char-btn" data-char="ó">ó</button>
                                <button class="char-btn" data-char="ú">ú</button>
                            </div>
                        </div>
                        <div class="character-group">
                            <h5>Underlined consonants</h5>
                            <div class="character-buttons">
                                <button class="char-btn" data-char="ḵ">ḵ</button>
                                <button class="char-btn" data-char="g̱">g̱</button>
                                <button class="char-btn" data-char="x̱">x̱</button>
                            </div>
                        </div>
                        <div class="character-group">
                            <h5>Circumflex consonants</h5>
                            <div class="character-buttons">
                                <button class="char-btn" data-char="ĝ">ĝ</button>
                                <button class="char-btn" data-char="x̂">x̂</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="page_container" class="row">
        <div class="large-12 columns">

            <!-- Dictionary Page -->
            <div class="page-content" id="dictionary-page">
                <div class="page" id="what_is_this">
                    <article>
                        <div class="row">
                            <div class="small-12 medium-10 columns small-centered">
                                <p>
                                    Kílgyaa is an interactive dictionary of X̱aad Kíl (the Haida language). It is a work in
                                    progress.
                                </p>
                                <p>
                                    Enter a word in plain or inflected form to see its entry.
                                </p>
                                <p>
                                    Spelling conventions: You can enter text with or without accents and special characters
                                    (e.g. <i>hlg̱ánggula</i> and <i>hlganggula</i> will perform the same search).
                                    Kílgyaa currently uses the orthography of Lachler's dictionary of Alaskan Haida.
                                </p>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

            <!-- Corpus Search Page -->
            <div class="page-content" id="corpus-page" style="display: none;">
                <div class="page">
                    <article>
                        <div class="row">
                            <div class="small-12 medium-10 columns small-centered">
                                <h2>Corpus Search</h2>
                                <p>Search through a collection of Haida texts and recordings to find words and phrases in context.</p>
                                <div class="coming-soon">
                                    <p><em>This feature is coming soon.</em></p>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

            <!-- Verb Conjugator Page -->
            <div class="page-content" id="conjugator-page" style="display: none;">
                <div class="page">
                    <article>
                        <div class="row">
                            <div class="small-12 medium-10 columns small-centered">
                                <h2>Verb Conjugator</h2>
                                <p>Explore verb conjugations in Haida.</p>
                                <div class="coming-soon">
                                    <p><em>This feature is coming soon.</em></p>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

            <!-- Lessons Page -->
            <div class="page-content" id="lessons-page" style="display: none;">
                <div class="page">
                    <article>
                        <div class="row">
                            <div class="small-12 medium-10 columns small-centered">
                                <h2>Language Lessons</h2>
                                <p>Learn Haida through structured lessons and exercises.</p>
                                <div class="coming-soon">
                                    <p><em>This feature is coming soon.</em></p>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

            <!-- Resources Page -->
            <div class="page-content" id="resources-page" style="display: none;">
                <div class="page">
                    <article>
                        <div class="row">
                            <div class="small-12 medium-10 columns small-centered">
                                <h2>External Resources</h2>
                                <p>Links to other Haida language materials and resources.</p>
                                <ul class="resource-links">
                                    <li><a href="https://www.firstvoices.com/xaad-kil-massett" target="_blank">FirstVoices Haida (Massett)</a></li>
                                    <li><a href="https://www.firstvoices.com/hlgaagilda-xaayda-kil" target="_blank">FirstVoices Haida (Skidegate)</a></li>
                                </ul>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

            <!-- Acknowledgements Page -->
            <div class="page-content" id="acknowledgements-page" style="display: none;">
                <div class="page">
                    <article>
                        <div class="row">
                            <div class="small-12 medium-10 columns small-centered">
                                <h2>Acknowledgements</h2>
                                <p>This dictionary project builds upon the work of many speakers, community members, and linguists.</p>

                                <h3>Written Sources</h3>
                                <p>Entries are sourced from: (TBD)</p>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="src/dictionary-data.js"></script>
    <script src="src/ipa-converter.js"></script>
    <script src="src/orthography-converter.js"></script>
    <script>

        function createResultsContainer() {
            if ($('#search-results').length === 0) {
                const resultsHtml = `
                    <div id="search-results" class="search-results" style="display: none;">
                        <div class="results-container">
                            <div class="results-header">
                                <h3>Dictionary Entries (click to expand)</h3>
                            </div>
                            <div class="results-list"></div>
                        </div>
                    </div>
                `;
                $('#page_container').prepend(resultsHtml);
            }
        }

        function displayResults(entries, orthography = 'lachler') {
            const resultsList = $('.results-list');
            resultsList.empty();
            
            entries.forEach((entry, index) => {
                // Get the word in the current orthography
                const word = entry[orthography] || entry.lachler;
                
                // Calculate IPA from Lachler form
                const pronunciation = lachlerToIPA(entry.lachler);
                
                // Build examples HTML
                let examplesHtml = '';
                if (entry.examples && entry.examples.length > 0) {
                    examplesHtml = '<div class="detail-section"><h6>Examples</h6><div class="examples">';
                    entry.examples.forEach(example => {
                        const exampleSentence = example[orthography] || example.lachler;
                        examplesHtml += `
                            <div class="example-item">
                                <div class="example-sentence">${exampleSentence}</div>
                                <div class="example-translation">"${example.translation}"</div>
                            </div>
                        `;
                    });
                    examplesHtml += '</div></div>';
                }
                
                // Build inflections HTML
                let inflectionsHtml = '';
                const inflections = (entry.inflections && entry.inflections[orthography]) ? 
                    entry.inflections[orthography] : 
                    (entry.inflections && entry.inflections.lachler) ? entry.inflections.lachler : [];
                if (inflections.length > 0) {
                    inflectionsHtml = '<div class="detail-section"><h6>Inflections</h6><div class="inflections">';
                    inflections.forEach(inflection => {
                        inflectionsHtml += `<span class="inflection-item">${inflection}</span>`;
                    });
                    inflectionsHtml += '</div></div>';
                }
                
                // Build notes HTML
                let notesHtml = '';
                if (entry.notes) {
                    notesHtml = `<div class="detail-section"><h6>Notes</h6><div class="notes">${entry.notes}</div></div>`;
                }
                
                // Build grammar HTML
                let grammarHtml = '';
                if (entry.grammar) {
                    grammarHtml = `<div class="detail-section"><h6>Grammar</h6><div class="grammar">${entry.grammar}</div></div>`;
                }
                
                // Get classifier or inflection class for compact display
                let compactGrammar = '';
                if (entry.type === 'noun' && entry.classifier) {
                    const classifier = typeof entry.classifier === 'object' ? 
                        (entry.classifier[orthography] || entry.classifier.lachler || entry.classifier) : 
                        entry.classifier;
                    compactGrammar = `classifier: ${classifier}`;
                } else if (entry.type === 'verb' && entry.inflectionClass) {
                    compactGrammar = entry.inflectionClass;
                }
                
                const entryHtml = `
                    <div class="entry-item clickable-entry" data-entry-id="${index}">
                        <div class="entry-header">
                            <div class="entry-main">
                                <div class="entry-left">
                                    <div class="entry-word">
                                        <strong>${word}</strong>
                                        <span class="entry-type">(${entry.type})</span>
                                        ${compactGrammar ? `<span class="entry-grammar">${compactGrammar}</span>` : ''}
                                    </div>
                                    <div class="entry-definition">${entry.definition}</div>
                                </div>
                                <div class="entry-right">
                                    <div class="entry-pronunciation">[${pronunciation}]</div>
                                </div>
                            </div>
                        </div>
                        <div class="entry-details" id="details-${index}" style="display: none;">
                            ${grammarHtml}
                            ${examplesHtml}
                            ${inflectionsHtml}
                            ${notesHtml}
                        </div>
                    </div>
                `;
                resultsList.append(entryHtml);
            });
            
            $('#search-results').show();
            $('#what_is_this').hide();
        }

        function normalizeText(text) {
            // Unicode normalization (NFD) to separate combining characters
            const normalized = text.normalize('NFD').toLowerCase();
            
            return normalized
                // Remove combining diacritical marks (accents, underlines, etc.)
                .replace(/[\u0300-\u036f]/g, '')
                // Handle specific Haida characters
                .replace(/[x̱]/g, 'x')
                .replace(/[g̱]/g, 'g')
                .replace(/[ḵ]/g, 'k')
                // Handle apostrophes and quotes
                .replace(/[k']/g, 'k')
                .replace(/['']/g, '')
                // Keep only alphanumeric characters
                .replace(/[^a-z0-9]/g, '');
        }

        function filterEntries(query, orthography = 'lachler') {
            if (!query) {
                return placeholderEntries.slice(0, 6); // Show first 6 entries by default
            }
            
            const normalizedQuery = normalizeText(query);
            return placeholderEntries.filter(entry => {
                const word = entry[orthography] || entry.lachler;
                return normalizeText(word).includes(normalizedQuery) ||
                       normalizeText(entry.definition).includes(normalizedQuery);
            }).slice(0, 8); // Show up to 8 matching entries
        }

        $(document).ready(function () {
            $('.search .keyword').first().focus(); // load page with search bar selected
            
            // Create results container
            createResultsContainer();
            
            // Auto-display functionality
            $('.search .keyword').on('input', function() {
                const query = $(this).val().trim();
                const orthography = $('#orthography-select').val();
                
                // Mark that user has typed something
                if (query.length > 0) {
                    $(this).data('has-typed', true);
                    const filteredEntries = filterEntries(query, orthography);
                    displayResults(filteredEntries, orthography);
                } else {
                    $('#search-results').hide();
                    $('#what_is_this').show();
                }
            });
            
            // Show initial entries when focusing on empty input (but not on page load)
            $('.search .keyword').on('focus', function() {
                // Only show entries if user has previously typed something
                // This prevents showing entries immediately on page load
                if ($(this).val().trim() === '' && $(this).data('has-typed')) {
                    const orthography = $('#orthography-select').val();
                    displayResults(filterEntries('', orthography), orthography);
                }
            });
            
            // Clear button functionality:
            $('.search-form_clear-button_js').click(function (e) {
                e.preventDefault();
                $('.search .keyword').val("").removeData('has-typed');
                $('.search .keyword').first().focus();
                $('#search-results').hide();
                $('#what_is_this').show();
            });

            // Keyboard panel functionality
            $('.keyboard-button_js').click(function (e) {
                e.preventDefault();
                $('#character-panel').toggle();
            });

            // Character panel close button
            $('.character-panel-close').click(function (e) {
                e.preventDefault();
                $('#character-panel').hide();
            });

            // Character button clicks
            $('.char-btn').click(function (e) {
                e.preventDefault();
                const char = $(this).data('char');
                const input = $('.search .keyword');
                const currentValue = input.val();
                const cursorPos = input[0].selectionStart || currentValue.length;
                
                // Insert character at cursor position
                const newValue = currentValue.slice(0, cursorPos) + char + currentValue.slice(cursorPos);
                input.val(newValue);
                
                // Set cursor position after inserted character
                input[0].setSelectionRange(cursorPos + char.length, cursorPos + char.length);
                
                // Trigger input event to update search results
                input.trigger('input');
                
                // Focus back on input
                input.focus();
            });

            // Close character panel when clicking outside
            $(document).click(function (e) {
                if (!$(e.target).closest('#character-panel, .keyboard-button_js').length) {
                    $('#character-panel').hide();
                }
            });

            // Expand/collapse entry details by clicking anywhere on entry
            $(document).on('click', '.clickable-entry', function (e) {
                e.preventDefault();
                const entryId = $(this).data('entry-id');
                const detailsSection = $('#details-' + entryId);
                const entry = $(this);
                
                if (detailsSection.is(':visible')) {
                    // Collapse
                    detailsSection.slideUp(200);
                    entry.removeClass('expanded');
                } else {
                    // Expand
                    detailsSection.slideDown(200);
                    entry.addClass('expanded');
                }
            });

            // Page navigation
            $('.nav-link').click(function(e) {
                e.preventDefault();
                const targetPage = $(this).data('page');
                
                // Update active nav
                $('.nav-link').removeClass('active');
                $(this).addClass('active');
                
                // Show/hide pages
                $('.page-content').hide();
                $('#' + targetPage + '-page').show();
                
                // Hide search form and results for non-dictionary pages
                if (targetPage === 'dictionary') {
                    $('.search').show();
                } else {
                    $('.search').hide();
                    $('#search-results').hide();
                    $('#what_is_this').show();
                }
            });

            // Orthography switching
            $('#orthography-select').change(function() {
                const newOrthography = $(this).val();
                
                // Re-run search if results are visible
                if ($('#search-results').is(':visible')) {
                    const query = $('.search .keyword').val().trim();
                    if (query.length > 0) {
                        const filteredEntries = filterEntries(query, newOrthography);
                        displayResults(filteredEntries, newOrthography);
                    } else {
                        const filteredEntries = filterEntries('', newOrthography);
                        displayResults(filteredEntries, newOrthography);
                    }
                }
            });
        })
    </script>


</body>

</html>